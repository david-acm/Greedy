properties:
  environmentId: "/subscriptions/7643973f-a34b-4ac2-91a9-4705285f14e6/resourceGroups/greedy_group/providers/Microsoft.App/managedEnvironments/cae-greedy-eus-dev"
  workloadProfileName: Consumption
  configuration:
    ingress:
      additionalPortMappings:
      - exposedPort: 2113
        external: true
        targetPort: 2113
      allowInsecure: false
      external: true
      targetPort: 2113
      exposedPort: 2113
      traffic:
      - latestRevision: true
        weight: 100
      transport: tcp
      allowCredentials: true
  template:
    containers:
    - image: eventstore/eventstore:23.10.0-bookworm-slim
      name: secure-esdb
      volumeMounts:
      - mountPath: "./certs"
        volumeName: certs
      env:
      - name: EVENTSTORE_CLUSTER_SIZE
        value: 1
      - name: EVENTSTORE_RUN_PROJECTIONS
        value: All
      - name: EVENTSTORE_START_STANDARD_PROJECTIONS
        value: true
      - name: EVENTSTORE_EXT_TCP_PORT
        value: 1113
      - name: EVENTSTORE_HTTP_PORT
        value: 2113
      - name: EVENTSTORE_INSECURE
        value: false
      - name: EVENTSTORE_ENABLE_EXTERNAL_TCP
        value: true
      - name: EVENTSTORE_ENABLE_ATOM_PUB_OVER_HTTP
        value: true
      - name: EVENTSTORE_TRUSTED_ROOT_CERTIFICATES_PATH
        value: /certs/ca
      - name: EVENTSTORE_CERTIFICATE_FILE
        value: /certs/node1/node.crt
      - name: EVENTSTORE_CERTIFICATE_PRIVATE_KEY_FILE
        value: /certs/node1/node.key
    initContainers:
    - image: warbear/es-gencert-greedy:greedy
      name: setup
      volumeMounts:
      - mountPath: "./certs"
        volumeName: certs
      command: 
      - "/bin/bash"
      args:
      - "-c"
      - >
        echo "0. whoami" &&
        whoami &&
        echo "1. makedir" &&
        mkdir ~/localcerts &&
        mkdir -p ./certs &&
        echo "2. cd ~/localcerts" &&
        cd ~/localcerts &&
        echo "3. es-gencert-cli create-ca" &&
        es-gencert-cli create-ca -out ~/localcerts/ca
        echo "4. cat" &&
        cat ~/localcerts/ca/ca.crt &&
        echo "5. create-node (path)" &&
        es-gencert-cli create-node -ca-certificate ~/localcerts/ca/ca.crt -out ./node1 -ip-addresses 4.157.224.169 -dns-names secure-node--w7bt0vq.grayglacier-cd091ed2.eastus.azurecontainerapps.io && 
        echo "6. Copy to ./certs" &&
        cd ../.. &&
        pwd &&
        cp -r ~/localcerts/* ./certs/
    scale:
      maxReplicas: 1
      minReplicas: 1
      rules:
      - name: httpscalingrule
        custom:
          type: http
          metadata:
            concurrentRequests: '50'
    volumes:
    - name: certs
      storageType: AzureFile
      storageName: stggreedyeusdev